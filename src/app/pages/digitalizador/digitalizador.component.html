<main class="container main py-5 mx-auto">
  <section class="digitalizador">
    <div class="digitalizador__toolbar">
      <div class="toolbar__side">
        <div>
          <button mat-raised-button (click)="toggleMonitoreo()" class="btn" [disabled]="sinConfiguracion"
            [title]="sinConfiguracion ? 'Falta configuración' : 'Iniciar / Detener monitoreo'">
            <div>
              <svg class="button-icon" *ngIf="isMonitoring; else notMonitoring" xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 384 512">
                <path
                  d="M0 128C0 92.7 28.7 64 64 64H320c35.3 0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128z" />
              </svg>
              <ng-template #notMonitoring>
                <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                  <path
                    d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80L0 432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z" />
                </svg>
              </ng-template>
            </div>
          </button>
        </div>
        <div *ngIf="isMonitoring" class="monitoring">
          <div class="justify-start animate-spin">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-rotate-clockwise">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M4.05 11a8 8 0 1 1 .5 4m-.5 5v-5h5" />
            </svg>
          </div>
          <div class="monitoring__text">
            <p class="">Monitoreando...</p>
          </div>
        </div>
      </div>
      <div class="toolbar__side">
        <button mat-raised-button (click)="toggleModal_UploadEsperadosTipoArchivo()">
          <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="icon icon-tabler icons-tabler-outline icon-tabler-file-upload">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M14 3v4a1 1 0 0 0 1 1h4" />
            <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
            <path d="M12 11v6" />
            <path d="M9.5 13.5l2.5 -2.5l2.5 2.5" />
          </svg>
        </button>
        <button mat-raised-button (click)="toggleModalConfiguraciones()">
          <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="icon icon-tabler icons-tabler-outline icon-tabler-settings">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path
              d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z" />
            <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
          </svg>
        </button>
      </div>
    </div>
    <div class="digitalizador__estado">
      <form [formGroup]="formFiltrosDigitalizador" class="form" style="max-width: 100%;">
        <div class="form__row form__row--responsive">
          <div class="form__item">
            <mat-form-field class="w-full">
              <mat-label>Fecha digitalización</mat-label>
              <mat-date-range-input [rangePicker]="picker">
                <input matStartDate formControlName="fechaInicio" placeholder="Inicio" />
                <input matEndDate formControlName="fechaFin" placeholder="Fin" />
              </mat-date-range-input>
              <mat-hint>DD/MM/YYYY – DD/MM/YYYY</mat-hint>
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-date-range-picker #picker></mat-date-range-picker>
            </mat-form-field>
          </div>
          <div class="form__item">
            <mat-form-field class="w-full">
              <mat-label>Tipos</mat-label>
              <mat-select formControlName="tipo">
                <mat-option value="">- Selecciona una opción -</mat-option>
                @for (tdd of tipos; track tdd) {
                <mat-option [value]="tdd.id">{{tdd.tipo_doc_dig}}</mat-option>
                }
              </mat-select>
              <mat-hint *ngIf="formFiltrosDigitalizador.get('grupo')?.disabled">
                Selecciona un tipo y fechas válidas para habilitar
              </mat-hint>
            </mat-form-field>
          </div>
        </div>
        <div class="form__row">
          <div class="form__item">
            <mat-form-field class="w-full">
              <mat-label>Grupo</mat-label>
              <mat-select formControlName="grupo">
                <mat-option value="">- Selecciona una opción -</mat-option>
                @for (grupo of grupos; track grupo) {
                <mat-option [value]="grupo.nombre_archivo_upload">{{grupo.nombre_archivo_upload}}</mat-option>
                }
              </mat-select>
              <mat-hint *ngIf="formFiltrosDigitalizador.get('grupo')?.disabled">
                Selecciona un tipo y fechas válidas para habilitar
              </mat-hint>
            </mat-form-field>
          </div>
        </div>
      </form>

      <div class="chart">
        <div>
          <canvas #myBarChart class="w-full h-full" id="myBarChart"> {{ chart }} </canvas>
        </div>

        <div class="numeros">
          <div class="numeros__item">
            <span class="">{{ esperadas | number}}</span>
            <span>Esperadas</span>
          </div>
          <div class="numeros__item">
            <span class="">{{ digitalizadas | number }}</span>
            <span>Digitalizadas</span>
          </div>
          <div class="numeros__item">
            <span class="">{{ enviadas | number}}</span>
            <span>Enviadas</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="busqueda">
    <form [formGroup]="formBusqueda" class="form busqueda__form" style="max-width: 100%;">
      <div class="form__row">
        <div class="form__item">
          <mat-form-field class="w-full">
            <mat-label>Nombre Archivo Upload</mat-label>
            <input matInput formControlName="search" (keyup)="getArchivosEsperados()" placeholder="Nombre del archivo">
          </mat-form-field>
        </div>
      </div>
    </form>

    <mat-list class="busqueda__list" role="list">
      @for (archivo of archivosEsperados; track archivo.id) {
      <mat-list-item role="listitem">
        <div class="busqueda__list__item">
          <span class="busqueda__list__item__archivo">{{ archivo.nombre_archivo }}</span>
          <small class="busqueda__list__item__status">{{ archivo.status == 1 ? 'Digitalizada' : 'Pendiente' }}</small>
        </div>
      </mat-list-item>
      } @empty {
      <mat-list-item role="listitem">No se encontraron archivos</mat-list-item>
      }
    </mat-list>
  </section>
</main>

@if(showModal_configuraciones){
<!-- Modal -->
<!-- Button to open the modal -->
<!-- Background overlay -->
<div class="fixed inset-0 transition-opacity" aria-hidden="true" (click)="toggleModalConfiguraciones()">
  <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
</div>
<!-- Modal -->
<div x-show="showModal_configuraciones" x-transition:enter="transition ease-out duration-300 transform"
  class="fixed z-10 inset-0 overflow-y-auto" x-cloak>
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Modal Configuraciones Globales -->
    <div style="min-width: 800px;"
      class="w-full inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full"
      role="dialog" aria-modal="true" aria-labelledby="modal-headline">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <!-- Modal content -->
        <div class="flex flex-col items-center justify-center">
          <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-headline">
              Configuraciones
            </h3>

            <form [formGroup]="formConfiguracion" class="form busqueda__form">
              <div class="form__row">
                <div class="form__item">
                  <button mat-raised-button matSuffix (click)="selectFolder('rutaOrigen')">
                    <mat-icon>folder</mat-icon>
                    <span>Seleccionar ruta origen</span>
                  </button>
                </div>
                <div class="form__item">
                  <button mat-raised-button matSuffix (click)="selectFolder('rutaDestino')">
                    <mat-icon>folder</mat-icon>
                    <span>Seleccionar ruta destino</span>
                  </button>
                </div>
              </div>
              <div class="form__row">
                <div class="form__item" (click)="selectFolder('rutaOrigen')">
                  <mat-form-field class="w-full">
                    <mat-label>Ruta origen</mat-label>
                    <input matInput formControlName="rutaOrigen" webkitdirectory directory id="sourceInput" readonly />
                  </mat-form-field>
                </div>
              </div>
              <div class="form__row">
                <div class="form__item" (click)="selectFolder('rutaDestino')">
                  <mat-form-field class="w-full">
                    <mat-label>Ruta destino</mat-label>
                    <input matInput formControlName="rutaDestino" webkitdirectory directory id="destinationInput"
                      readonly />
                  </mat-form-field>
                </div>
              </div>
              <div class="form__row">
                <mat-form-field class="w-full">
                  <mat-label>Tipo Documento a Digitalizar</mat-label>
                  <mat-select class="w-full" formControlName="tipo">
                    <mat-option class="w-full" *ngFor="let tipo of tipos" [value]="tipo.id">{{ tipo.tipo_doc_dig
                      }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <div class="form__row">
                <div class="form__item">
                  <mat-form-field class="w-full">
                    <mat-label>Expresión Regular</mat-label>
                    <input matInput formControlName="regexCurp" />
                  </mat-form-field>
                </div>
              </div>
              <div class="form__row">
                <div class="form__item">
                  <mat-form-field class="w-full">
                    <mat-label>Extensión</mat-label>
                    <mat-select class="" formControlName="extension">
                      <mat-option class="" *ngFor="let extension of extensiones" [value]="extension.nombre">{{
                        extension.nombre }}</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                <div class="form__item">
                  <mat-form-field class="w-full">
                    <mat-label>Intervalo de sincronización (s)</mat-label>
                    <input matInput formControlName="intervaloSincronizacion" placeholder="Tiempo en segundos" min="1">
                  </mat-form-field>
                </div>
                <div class="form__item">
                  <mat-form-field class="w-full">
                    <mat-label>Peso mínimo (KB)</mat-label>
                    <input matInput formControlName="pesoMinimo" placeholder="Peso minimo en kilobytes" min="1">
                  </mat-form-field>
                </div>
              </div>
            </form>

            <div class="mt-2">
              <div class="input-group">
                <input type="file" webkitdirectory directory (change)="onSourcePathSelected($event)"
                  style="display: none" />
                <input type="file" id="" webkitdirectory directory (change)="onDestinationPathSelected($event)"
                  style="display: none" />
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button (click)="saveConfig()" type="button"
          class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-500 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
          Guardar
        </button>
        <button (click)="toggleModalConfiguraciones()" type="button"
          class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-200 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

}

@if(showModal_upload_esperados_tipo_archivo){
<div class="fixed inset-0 transition-opacity" aria-hidden="true" (click)="toggleModal_UploadEsperadosTipoArchivo()">
  <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
</div>
<!-- Modal -->
<div x-show="showModal_upload_esperados_tipo_archivo" x-transition:enter="transition ease-out duration-300 transform"
  class="fixed z-10 inset-0 overflow-y-auto" x-cloak>
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Modal Upload Esperados por Tipo de Documento -->
    <div
      class="w-full inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full"
      role="dialog" aria-modal="true" aria-labelledby="modal-headline">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <!-- Modal content -->
        <div class="flex flex-col items-center justify-center">
          <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-headline">
              Importación de archivos esperados
            </h3>

            <form [formGroup]="myForm_Upload" class="my-3">
              <div class="form__row">
                <div class="form__item">
                  <button mat-raised-button class="w-full">
                    <label for="txtFile" class="w-full text-nowrap">
                      Importar Archivos Esperados XLSX
                    </label>
                    <div>
                      <input type="file" #fileInput id="txtFile" accept=".xls,.xlsx" style="display:none;" name="file"
                        formControlName="file" (change)="onFileSelected($event)">
                    </div>
                  </button>
                </div>
                <div class="form__item">
                  <button mat-raised-button (click)="downloadPlantilla()">Descargar plantilla</button>
                </div>
              </div>
            </form>

          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button (click)="toggleModal_UploadEsperadosTipoArchivo()" type="button"
          class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-200 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

}